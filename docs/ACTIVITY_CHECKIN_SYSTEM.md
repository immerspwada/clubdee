# Activity Check-in System with QR Code

## Overview

ระบบเช็คอินกิจกรรมด้วย QR Code พร้อมระบบลงทะเบียนล่วงหน้า สำหรับกิจกรรมต่างๆ เช่น อบรม แข่งขัน ฝึกซ้อม และอื่นๆ

## Features Implemented

### 1. ระบบเช็คอินด้วย QR Code

**สำหรับโค้ช:**
- สร้างกิจกรรมใหม่ (อบรม, แข่งขัน, ฝึกซ้อม, อื่นๆ)
- สร้าง QR Code สำหรับแต่ละกิจกรรม
- แสดง QR Code ให้นักกีฬาสแกน
- ดาวน์โหลด QR Code เป็นรูปภาพ
- คัดลอกรหัส QR Code

**สำหรับนักกีฬา:**
- สแกน QR Code เพื่อเช็คอิน
- หรือกรอกรหัสด้วยตนเอง
- ระบบบันทึกเวลาเข้า-ออก
- ระบบตรวจสอบสถานะ: มาตรงเวลา / มาสาย / ขาด

**ช่วงเวลาเช็คอิน:**
- เช็คอินได้ก่อนเริ่ม: 30 นาที (ปรับได้)
- เช็คอินได้หลังเริ่ม: 15 นาที (ปรับได้)
- หากเช็คอินหลังเวลาเริ่ม จะถูกบันทึกว่า "สาย"

### 2. ระบบลงทะเบียนล่วงหน้า

**สำหรับนักกีฬา:**
- ลงทะเบียนเข้าร่วมกิจกรรม
- ระบุเหตุผลที่ต้องการเข้าร่วม
- ยกเลิกการลงทะเบียน (ถ้ายังรออนุมัติ)
- ดูสถานะการลงทะเบียน

**สำหรับโค้ช:**
- ดูรายชื่อผู้ลงทะเบียนทั้งหมด
- อนุมัติ/ไม่อนุมัติการลงทะเบียน
- ระบุเหตุผลที่ไม่อนุมัติ
- ลบนักกีฬาออกจากกิจกรรม
- จำกัดจำนวนผู้เข้าร่วม

## Database Schema

### Tables Created

1. **activities** - กิจกรรมต่างๆ
   - ข้อมูลกิจกรรม (ชื่อ, ประเภท, วันที่, เวลา, สถานที่)
   - QR Code token และวันหมดอายุ
   - ช่วงเวลาเช็คอิน
   - จำนวนผู้เข้าร่วมสูงสุด
   - ต้องลงทะเบียนหรือไม่

2. **activity_registrations** - การลงทะเบียน
   - ข้อมูลการลงทะเบียน
   - สถานะ (pending, approved, rejected, cancelled)
   - เหตุผลจากนักกีฬา
   - เหตุผลจากโค้ช

3. **activity_checkins** - การเช็คอิน
   - เวลาเช็คอิน/เช็คเอาท์
   - สถานะ (on_time, late, absent)
   - วิธีเช็คอิน (qr, manual, auto)
   - QR token ที่ใช้

### Helper Functions

- `generate_activity_qr_token()` - สร้าง QR token
- `is_checkin_window_valid()` - ตรวจสอบช่วงเวลาเช็คอิน
- `determine_checkin_status()` - กำหนดสถานะ (ตรงเวลา/สาย)
- `get_activity_registration_count()` - นับจำนวนผู้ลงทะเบียน
- `is_activity_full()` - ตรวจสอบว่าเต็มหรือไม่

## Pages & Routes

### Athlete Routes

- `/dashboard/athlete/activities` - หน้ากิจกรรมทั้งหมด
  - Tab: กิจกรรมที่กำลังจะมาถึง
  - Tab: การลงทะเบียนของฉัน
  - Tab: กิจกรรมที่ผ่านมา

### Coach Routes

- `/dashboard/coach/activities` - หน้าจัดการกิจกรรม
  - สร้างกิจกรรมใหม่
  - สร้าง/แสดง QR Code
  - จัดการการลงทะเบียน

## Components

### Athlete Components

- `ActivityList` - แสดงรายการกิจกรรม
- `QRCodeScanner` - สแกน QR Code เพื่อเช็คอิน

### Coach Components

- `CreateActivityDialog` - สร้างกิจกรรมใหม่
- `CoachActivityList` - แสดงรายการกิจกรรมของโค้ช
- `QRCodeDisplay` - แสดง QR Code
- `RegistrationManagement` - จัดการการลงทะเบียน

## Server Actions

### Activity Actions (`lib/activity/actions.ts`)

- `createActivity()` - สร้างกิจกรรม
- `generateQRCode()` - สร้าง QR Code
- `registerForActivity()` - ลงทะเบียนกิจกรรม
- `cancelRegistration()` - ยกเลิกการลงทะเบียน
- `approveRegistration()` - อนุมัติการลงทะเบียน
- `rejectRegistration()` - ไม่อนุมัติการลงทะเบียน
- `removeAthleteFromActivity()` - ลบนักกีฬาออก
- `checkInWithQR()` - เช็คอินด้วย QR Code
- `checkOutFromActivity()` - เช็คเอาท์

## Security (RLS Policies)

### Activities
- Admins: เข้าถึงได้ทั้งหมด
- Coaches: จัดการกิจกรรมในสโมสรของตน
- Athletes: ดูกิจกรรมในสโมสรของตน

### Registrations
- Admins: เข้าถึงได้ทั้งหมด
- Coaches: จัดการการลงทะเบียนในกิจกรรมของตน
- Athletes: ลงทะเบียนและดูการลงทะเบียนของตน

### Check-ins
- Admins: เข้าถึงได้ทั้งหมด
- Coaches: จัดการการเช็คอินในกิจกรรมของตน
- Athletes: เช็คอินและดูการเช็คอินของตน (ต้องอยู่ในช่วงเวลาที่กำหนด)

## Usage Examples

### สร้างกิจกรรมใหม่ (โค้ช)

1. ไปที่ `/dashboard/coach/activities`
2. คลิก "สร้างกิจกรรม"
3. กรอกข้อมูล:
   - ชื่อกิจกรรม
   - ประเภท (ฝึกซ้อม, แข่งขัน, ทดสอบ, อื่นๆ)
   - วันที่และเวลา
   - สถานที่
   - ต้องลงทะเบียนหรือไม่
   - จำนวนผู้เข้าร่วมสูงสุด (ถ้าต้องการจำกัด)
4. คลิก "สร้างกิจกรรม"

### สร้าง QR Code (โค้ช)

1. ในหน้ากิจกรรม คลิก "สร้าง QR"
2. QR Code จะถูกสร้างและแสดงขึ้นมา
3. สามารถ:
   - แสดง QR Code ให้นักกีฬาสแกน
   - ดาวน์โหลดเป็นรูปภาพ
   - คัดลอกรหัส

### ลงทะเบียนกิจกรรม (นักกีฬา)

1. ไปที่ `/dashboard/athlete/activities`
2. เลือกกิจกรรมที่ต้องการ
3. คลิก "ลงทะเบียน"
4. ระบุเหตุผล (ถ้าต้องการ)
5. รอโค้ชอนุมัติ

### เช็คอินด้วย QR Code (นักกีฬา)

1. ไปที่ `/dashboard/athlete/activities`
2. เลือกกิจกรรมที่ต้องการเช็คอิน
3. คลิก "สแกน QR"
4. สแกน QR Code ที่โค้ชแสดง หรือกรอกรหัสด้วยตนเอง
5. คลิก "เช็คอิน"
6. ระบบจะบันทึกเวลาและสถานะ

### อนุมัติการลงทะเบียน (โค้ช)

1. ในหน้ากิจกรรม คลิก "จัดการลงทะเบียน"
2. ดูรายชื่อผู้ลงทะเบียน
3. คลิก "อนุมัติ" หรือ "ไม่อนุมัติ"
4. ถ้าไม่อนุมัติ ระบุเหตุผล

## Migration Files

- `scripts/50-create-activity-checkin-system.sql` - สร้าง tables และ functions
- `scripts/51-activity-checkin-rls-policies.sql` - สร้าง RLS policies

## Dependencies Added

- `qrcode` - สร้าง QR Code
- `@types/qrcode` - TypeScript types
- `@radix-ui/react-tabs` - Tabs component
- `@radix-ui/react-checkbox` - Checkbox component

## Testing

### Manual Testing Steps

1. **สร้างกิจกรรม (โค้ช)**
   - ทดสอบสร้างกิจกรรมแต่ละประเภท
   - ทดสอบกับ/ไม่มีการลงทะเบียน
   - ทดสอบจำกัดจำนวนผู้เข้าร่วม

2. **สร้าง QR Code (โค้ช)**
   - ทดสอบสร้าง QR Code
   - ทดสอบดาวน์โหลด
   - ทดสอบคัดลอกรหัส

3. **ลงทะเบียน (นักกีฬา)**
   - ทดสอบลงทะเบียนกิจกรรม
   - ทดสอบยกเลิกการลงทะเบียน
   - ทดสอบลงทะเบียนซ้ำ (ควรไม่ได้)

4. **เช็คอิน (นักกีฬา)**
   - ทดสอบเช็คอินก่อนเวลา (ควรไม่ได้)
   - ทดสอบเช็คอินในช่วงเวลาที่กำหนด
   - ทดสอบเช็คอินหลังเวลาเริ่ม (ควรเป็น "สาย")
   - ทดสอบเช็คอินหลังหมดเวลา (ควรไม่ได้)
   - ทดสอบเช็คอินซ้ำ (ควรไม่ได้)

5. **อนุมัติการลงทะเบียน (โค้ช)**
   - ทดสอบอนุมัติ
   - ทดสอบไม่อนุมัติพร้อมเหตุผล
   - ทดสอบลบนักกีฬาออก

## Future Enhancements

- เพิ่มการสแกน QR Code ด้วยกล้อง (ใช้ Web API)
- เพิ่มการแจ้งเตือนเมื่อมีการอนุมัติ/ไม่อนุมัติ
- เพิ่มรายงานสถิติการเข้าร่วมกิจกรรม
- เพิ่มการส่งออกรายชื่อผู้เข้าร่วม
- เพิ่มการเช็คเอาท์อัตโนมัติเมื่อกิจกรรมสิ้นสุด
- เพิ่มการแจ้งเตือนก่อนกิจกรรมเริ่ม
